<html>
    <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.css" />
	<script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script src="http://code.jquery.com/mobile/1.1.0/jquery.mobile-1.1.0.min.js"></script>
    <script type="text/javascript">
    function displayStation(urlObj, options) {
        var stationId = urlObj.hash.replace(/.*id=/, "");
        var main = $('#gare');
        var header = main.children( ":jqmData(role=header)" );
        var content = main.children( ":jqmData(role=content)" );
        $.mobile.showPageLoadingMsg();

        $.getJSON('http://sterops.pythonanywhere.com/json/GetGare/' + stationId + '/', function(data) {
            header.find( "h1" ).html(data.nom);

            var positionDiv = main.find('#position').find(".data").html(''),
                lignesDiv = main.find('#lignes').find(".data").html(''),
                ascenseursDiv = main.find('#ascenseurs').find(".data").html('');

            var link = $('<a></a>').attr('href', "http://maps.google.com/maps?q="+data["latitude"]+","+data["longitude"]+"&hl=fr");
            var map = $('<img></img>').attr('src', "http://maps.googleapis.com/maps/api/staticmap?center="+data["latitude"]+","+data["longitude"]
                                               + "&zoom=14&size=" + ($("#gare").width() - 45) + "x310&maptype=roadmap&markers=color:blue%7Clabel:G%7C"+data["latitude"]+","+data["longitude"]
                                               + "&sensor=false").appendTo(link);
            positionDiv.append("Gare de " + data["nom"] + " (" + data["ville"] + ", " + data["departement"] + ")").append($("<p></p>").append(link));

            var lignesUl = $('<ul>').appendTo(lignesDiv).attr("data-role", "listview").attr("data-inset", "false").attr("data-filter", "false");
            $.each(data["arrets"], function(index, ligne) {
                var li = $("<li></li>");
                var a = $("<a></a>").appendTo(li);
                a.id = ligne["id"];
                a.attr("href", "#ligne?id=" + ligne["id"]);
                a.append(ligne["reseau"] + " " + ligne["ligne"]);
                li.appendTo(lignesUl);
            });

            ascenseursUl = $('<ul>').appendTo(ascenseursDiv).attr("data-role", "listview").attr("data-inset", "false").attr("data-filter", "false");
            $.each(data["ascenseurs"], function(index, ascenseur) {
                var li = $("<li></li>");
                li.append('<h3 style="white-space: normal">' + ascenseur["situation"] + "</h3><p>" + ascenseur["direction"] + ' - Situation en date du ' + ascenseur["maj"] + '</p><p class="ui-li-aside">' + ascenseur["status"]+'</p>');
                if (ascenseur["status"] != "Disponible") {
                    li.attr("data-icon", "alert");
                    li.attr("data-theme", "e");
                }
                li.appendTo(ascenseursUl);
            });

            main.page();
            content.find( ":jqmData(role=listview)" ).listview();

            // We don't want the data-url of the page we just modified
        	// to be the url that shows up in the browser's location field,
	    	// so set the dataUrl option to the URL for the category
		    // we just loaded.
		    options.dataUrl = urlObj.href;

            // Do the page change
            $.mobile.hidePageLoadingMsg();
            $.mobile.changePage( main, options );
        });
    }

    function displayStationsByLine(urlObj, options) {
        var lineId = urlObj.hash.replace(/.*id=/, "");

        var main = $('#ligne');
        if (main.attr("ligneId") == lineId) {
            // Do the page change
            $.mobile.changePage( main, options );
            return;
        }

        var header = main.children( ":jqmData(role=header)" );
        var content = main.children( ":jqmData(role=content)" );

        $.mobile.showPageLoadingMsg();

        $.getJSON('http://sterops.pythonanywhere.com/json/GetGaresParLigne/' + lineId + '/', function(data) {
            content.html('');
            var ul = $('<ul>').appendTo(content).attr("data-role", "listview").attr("data-inset", "true").attr("data-filter", "true");

            var reseau = data["reseau"];
            var ligne = data["ligne"];

            header.find( "h1" ).html(reseau + " " + ligne);

            var gares = data["gares"];
            $.each(gares, function(index, gare) {
                var li = $("<li></li>");
                var a = $("<a></a>").appendTo(li);
                a.id = gare["id"];
                a.attr("href", "#gare?id=" + gare["id"]);
                if (gare["status"]) {
                    //li.addClass("gareOK");
                } else {
                    li.attr("data-icon", "alert");
                    li.attr("data-theme", "e");
                }
                a.append(gare["nom"]);
                li.appendTo(ul);
            });
            main.attr("ligneId", lineId);
            main.page();
            content.find( ":jqmData(role=listview)" ).listview();

            // We don't want the data-url of the page we just modified
    		// to be the url that shows up in the browser's location field,
	    	// so set the dataUrl option to the URL for the category
		    // we just loaded.
		    options.dataUrl = urlObj.href;

            // Do the page change
            $.mobile.hidePageLoadingMsg();
            $.mobile.changePage( main, options );
        });
    }

    function displayLines(urlObj, options) {
        var main = $("#main");
        var content = main.children( ":jqmData(role=content)" );
        if (content.html() != "") {
            // Do the page change
            $.mobile.changePage( main, options );
            return;
        }

        $.getJSON('http://sterops.pythonanywhere.com/json/GetLignes/', function(data) {
            content.html('');
            var ul = $('<ul>').appendTo(content).attr("data-role", "listview").attr("data-inset", "true").attr("data-filter", "true");

            $.each(data, function(index, ligne) {
                var li = $("<li></li>");
                var a = $("<a></a>").appendTo(li);
                a.id = ligne["id"];
                a.attr("href", "#ligne?id=" + ligne["id"]);
                a.append(ligne["reseau"] + ' ' + ligne["ligne"]);
                li.appendTo(ul);
            });

            main.page();

            content.find( ":jqmData(role=listview)" ).listview();

        	// We don't want the data-url of the page we just modified
    		// to be the url that shows up in the browser's location field,
	    	// so set the dataUrl option to the URL for the category
		    // we just loaded.
		    options.dataUrl = urlObj.href;

            // Do the page change
            $.mobile.changePage( main, options );
        });
    }

// Listen for any attempts to call changePage().
$(document).bind( "pagebeforechange", function( e, data ) {
    // We only want to handle changePage() calls where the caller is
	// asking us to load a page by URL.
	if ( typeof data.toPage === "string" ) {
		// We are being asked to load a page by URL, but we only
		// want to handle URLs that request the data for a specific
		// category.
		var u = $.mobile.path.parseUrl( data.toPage );
		if ( u.hash.indexOf("#ligne") == 0 ) {
			// Display one train line
            displayStationsByLine( u, data.options );

			// Make sure to tell changePage() we've handled this call so it doesn't
			// have to do anything.
        	e.preventDefault();
		} else if (u.hash.indexOf("#gare") == 0) {
            displayStation(u, data.options);

            e.preventDefault();

		} else if (u.hash == "") {
    	    displayLines(u, data.options);
            // Make sure to tell changePage() we've handled this call so it doesn't
			// have to do anything.
            e.preventDefault();
		}
	}
});

/*$(document).bind('pageinit', function(e, data) {
	var u = $.mobile.path.parseUrl( data.toPage );
    displayLines(u, data.options);

    // Make sure to tell changePage() we've handled this call so it doesn't
	// have to do anything.
	e.preventDefault();
});*/

$(document).ready(function() { displayLines(); });

    </script>
    <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-31909461-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
    </head>
    <body>
    <div id="main" data-role="page">
        <div data-role="header"><h1>Lignes</h1></div>
        <div data-role="content"></div>
        <div data-role="footer"><h4><a href="#popup" data-role="button" data-rel="dialog" data-transition="pop">À propos</a></h4></div>
    </div>
    <div id="ligne" data-role="page">
        <div data-role="header"><h1></h1>
            <a href="/static/index.html" data-icon="home" data-iconpos="notext">Accueil</a>
        </div>
        <div data-role="content"></div>
        <div data-role="footer">
        	<h4><a href="#popup" data-role="button" data-rel="dialog" data-transition="pop">À propos</a></h4>
	    </div>
    </div>
    <div id="gare" data-role="page" data-add-back-btn="true">
        <div data-role="header"><h1></h1>
            <a href="/static/index.html" data-icon="home" data-iconpos="notext">Accueil</a>
        </div>
        <div data-role="content">
            <div data-role="collapsible-set" data-theme="" data-content-theme="">
                <div data-role="collapsible" data-collapsed="true" id="position">
                    <h2>Position</h3>
                    <div class="data"></div>
                </div>
                <div data-role="collapsible" data-collapsed="true" id="lignes">
                    <h2>Lignes</h3>
                    <div class="data"></div>
                </div>
                <div data-role="collapsible" data-collapsed="false" id="ascenseurs">
                    <h2>Ascenseurs</h3>
                    <div class="data"></div>
                </div>
            </div>
        </div>
        <div data-role="footer">
    		<h4><a href="#popup" data-role="button" data-rel="dialog" data-transition="pop">À propos</a></h4>
	    </div>
    </div>
    <div data-role="page" id="popup">
        <div data-role="header" data-theme="e"><h1>À Propos</h1></div>
	    <div data-role="content" data-theme="d">
		    <h2>Info-mobile</h2>
    		<p>Info-mobile&nbsp;: l'information (presque) temps-réel sur l'accessibilité du réseau ferré d'Ile-de-France.</p>
            <p>Ce site est donné à titre indicatif uniquement. Il est possible que les informations qu'il contient soient incomplètes, inexactes ou en retard par rapport à la situation réelle.
            N'hésitez pas à me contacter si vous repérez de tels problèmes afin que je puisse y remédier.</p>
            <p>Le contenu de ce site est généré de manière automatique à partir de multiples sources publiques sur le réseau RATP et SNCF d'Ile-de-France, son accessibilité et l'état des équipements en gare.</p>
            <p>2012 - Etienne Membrives - Tous droits réservés</p>
    	</div>
    </div>
    </body>
</html>